syntax = "proto3";

package notification.v1;

import "common/v1/types.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/JrMarcco/kuryr-api/api/notification/v1";

// 发送状态
//  |-- PREPARE  - 准备中
//  |-- PENDING  - 挂起
//  |-- SUCCESS  - 成功
//  |-- FAILURE  - 失败
//  |-- CANCELED - 已取消
enum SendStatus {
  STATUS_UNSPECIFIED = 0;
  PREPARE = 1;
  PENDING = 2;
  SUCCESS = 3;
  FAILURE = 4;
  CANCEL = 5;
}

// 发送策略
message SendStrategy {
  oneof strategy_type {
    ImmediatelyStrategy immediate = 1;
    DelayedStrategy delayed = 2;
    ScheduledStrategy scheduled = 3;
    TimeWindowStrategy time_window = 4;
    DeadlineStrategy deadline = 5;
  }
}

// 发送策略 - 立即发送
message ImmediatelyStrategy {}

// 发送策略 - 延迟发送
message DelayedStrategy {
  int64 delay_seconds = 1;
}

// 发送策略 - 调度发送
message ScheduledStrategy {
  google.protobuf.Timestamp send_time = 1;
}

// 发送策略 - 时间窗口内发送
message TimeWindowStrategy {
  int64 start_time_millis = 1;
  int64 end_time_millis = 2;
}

// 发送策略 - 截止时间前发送
message DeadlineStrategy {
  google.protobuf.Timestamp deadline = 1;
}

// 消息
message Notification {
  string biz_key = 1;
  repeated string receivers = 2;
  common.v1.Channel channel = 3;
  string tpl_id = 4;
  map<string, string> tpl_params = 5;
  SendStrategy strategy = 6;
}

// 消息发送服务
service NotificationService {
  // 单条消息发送
  rpc Send(SendRequest) returns (SendResponse);
  // 单条消息异步发送
  rpc AsyncSend(AsyncSendRequest) returns (AsyncSendResponse);

  // 批量消息发送
  rpc BatchSend(BatchSendRequest) returns (BatchSendResponse);
  // 批量消息异步发送
  rpc AsyncBatchSend(AsyncBatchSendRequest) returns (AsyncBatchSendResponse);
}

// 发送结果，包含消息 id 以及发送状态和错误信息
message SendResult {
  string notification_id = 1;
  SendStatus status = 2;
  common.v1.ErrCode err_code = 3;
  string err_msg = 4;
}

// 单条消息发送请求
message SendRequest {
  Notification notification = 1;
}

// 单条消息发送响应
message SendResponse {
  SendResult result = 1;
}

// 单条消息异步发送请求
message AsyncSendRequest {
  Notification notification = 1;
}

// 单条消息异步发送响应
message AsyncSendResponse {
  SendResult result = 1;
}

// 批量消息发送请求
message BatchSendRequest {
  repeated Notification notifications = 1;
}

// 批量消息发送响应
message BatchSendResponse {
  repeated SendResult results = 1;
  int32 total_cnt = 2;
  int32 success_cnt = 3;
}

// 批量消息异步发送请求
message AsyncBatchSendRequest {
  repeated Notification notifications = 1;
}

// 批量消息异步发送响应
message AsyncBatchSendResponse {
  repeated uint64 notification_ids = 1;
}
